<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Rhino Rehab: Clinician View</title>

  <script src="https://www.gstatic.com/firebasejs/5.0.2/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyApdU4KZoEo3UFFnigOFLQ5BqzS4INBBF0",
      authDomain: "clinician-5062c.firebaseapp.com",
      databaseURL: "https://clinician-5062c.firebaseio.com",
      projectId: "clinician-5062c",
      storageBucket: "",
      messagingSenderId: "966676715905"
    };
    firebase.initializeApp(config);
  </script>

  <link rel="stylesheet" type="text/css" href="../mystyle.css">

  <style>
  </style>

  <script src="../jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
  <script src='https://unpkg.com/vue'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>

  <div id="app" style="height: 100%">

    <div style="text-align: right; padding: 2rem;">
      Clinician: {{user()}}.
      <button @click="logout()">Log out</button>
      </button>
    </div>

    <div class="container" style="background: rgba(255, 255, 255, .5); padding: 3rem; bottom: 2rem;">

      <div v-if="currentView=='login'">
        <h2>Begin Session</h2>
        Enter the patient's id:
        <input type="text" id="patient_id" v-model="patient_id">
        <button @click="beginSession()" class="button button-primary">Begin Session</button>

      </div>
      <div v-if="currentView!='login'">
        <div>In session with patient: {{patient_id}}. Session Time: {{duration()}}.
          <button @click="endSession()">End Session</button>
        </div>
        <div v-if="currentView=='start'">
          <h2>Choose an activity</h1>

            <div>
              <button @click="launchBoxAndBlocks()" class="button button-primary">Box and Blocks</button>
            </div>
            <div>
              <button @click="launchBalloonGame()" class="button button-primary">Balloons</button>
            </div>
            <div>
              <button @click="launchPlaneGame()" class="button button-primary">Airplanes</button>
            </div>
            <div>
              <button @click="launchCarGame()" class="button button-primary">Model Car</button>
            </div>
        </div>

        <div v-if="currentView=='clinician'">
          <div>
            <h2>Clinician View</h2>
          </div>
          <div>
            <button @click="toggleHoop()">Toggle Hoop Oscillation</button>{{planeGameSettings}}
          </div>
          <div>

          </div>
          <div>
            <table>
              <tr>
                <td>
                  Right Sensitivity:
                  <input type="number" min="1" max="10" v-model="leftSensitivity">
                </td>
                <td>

                </td>
                <td>
                  Left Sensitivity:
                  <input type="number" min="1" max="10" v-model="rightSensitivity">
                </td>

              </tr>
              <tr>
                <td>
                  Right visualus studius extents: xxx/xxx
                </td>
                <td rowspan="3">
                  <img src="../muscular.png" style="height:40rem">
                </td>
                <td>
                  Left visualus studius extents: xxx/xxx
                </td>
              </tr>
              <tr>
                <td>
                  Right eclipsus extents: xxx/xxx
                </td>
                <td>
                  Left eclipsus extents: xxx/xxx
                </td>
              </tr>
              <tr>
                <td>
                  Right netium benum extents: xxx/xxx
                </td>
                <td>
                  Left netium benum extents: xxx/xxx
                </td>
              </tr>
            </table>
            {{kinectData}}

          </div>
          <input type="file" id="file" @change="changePath()" style="display:none" />
          <p id="ttt">Please select the game path...</p>
          <button @click="setPath()">Change Path</button>
          <br />
          <button @click="backToStart()" class="button button-primary">Choose a different Activity</button>

        </div>
      </div>
    </div>
  </div>







  <script> 



    var child = require("child_process").spawn;
    var path = require("path");
    var fs = require("fs");
    var net = require("net");

    var client = new net.Socket();

    var app = new Vue({
      el: '#app',
      data: {
        socket: {},
        game: null,
        currentGame: "BoxAndBlocks",
        reply: "",
        rows: [],
        currentView: "login",
        patient_id: "",
        session_start: null,
        leftSensitivity: 5,
        rightSensitivity: 5,
        now: moment(),
        kinectData: [],
        planeGameSettings: {oscillation: false}
      },
      mounted() {

        var io = require("socket.io-client/dist/socket.io");
        this.socket = io("http://127.0.0.1:80");

        this.socket.emit("USER_CONNECT");


        this.socket.on("USER_CONNECTED", function (msg) {
          app.reply = msg;
          console.log("Client Connected " + msg.name);

        });
        this.socket.on("forClinician", function (data) {
          console.log(data);

          if (data.type == "toggleHoop")
          {
            app.planeGameSettings.oscillation = data.value;
          }
        });


      },
      methods: {
        setPath() {
          var f = document.getElementById("file");
          f.click();

        },
        changePath() {
          var f = document.getElementById("file");
          var pth = f.files[0].path.replace("\\", "\\\\")
          this.setText(pth);
          switch (this.currentGame) {
            case "BoxAndBlocks":

              localStorage.setItem("BoxAndBlocks", pth);
              break;
            case "PlaneGame":
              localStorage.setItem("PlaneGame", pth);
              break;
            case "BalloonGame":
              localStorage.setItem("BalloonGame", pth);
              break;
            case "CarGame":
              localStorage.setItem("CarGame", pth);
              break;
          }
        },
        launchBoxAndBlocks() {
          this.currentGame = "BoxAndBlocks";
          this.currentView = "clinician";
          var pth = localStorage.getItem("BoxAndBlocks");
          console.log(pth);
          //var pathToBinary = path.join(); 
          this.setText(pth);
          if (fs.existsSync(pth)) {
            this.game = child(pth);
            this.socket.emit("forUnity", { data: "blocks and blocks" });
          }
          else {
            console.error("Game location invalid");
            this.setText("Please set valid game location...");
          }

        },
        launchPlaneGame() {
          this.currentGame = "PlaneGame";
          this.currentView = "clinician";
          var pth = localStorage.getItem("PlaneGame");
          console.log(pth);
          //var pathToBinary = path.join(); 
          this.setText(pth);
          if (fs.existsSync(pth)) {
            this.game = child(pth);
            this.socket.emit("forUnity", { data: "plane game" });
          }
          else {
            console.error("Game location invalid");
            this.setText("Please set valid game location...");
          }

        },
        launchBalloonGame() {
          this.currentGame = "BalloonGame";
          this.currentView = "clinician";
          var pth = localStorage.getItem("BalloonGame");
          console.log(pth);
          //var pathToBinary = path.join(); 
          this.setText(pth);
          if (fs.existsSync(pth)) {
            this.game = child(pth);
            this.socket.emit("forUnity", { data: "balloon game" });
          }
          else {
            console.error("Game location invalid");
            this.setText("Please set valid game location...");
          }

        },
        launchCarGame() {
          this.currentGame = "CarGame";
          this.currentView = "clinician";
          var pth = localStorage.getItem("CarGame");
          console.log(pth);
          //var pathToBinary = path.join(); 
          this.setText(pth);
          if (fs.existsSync(pth)) {
            this.game = child(pth);
            this.socket.emit("forUnity", { data: "car game" });
          }
          else {
            console.error("Game location invalid");
            this.setText("Please set valid game location...");
          }

        },
        toggleHoop()
        {
          this.socket.emit("forUnity", { data: "toggleHoop"}); 
        },
        beginSession() {
          this.currentView = "start";
          var pId = document.getElementById("patient_id").value;
          this.patient_id = pId;
          var type = "Clinician";
          var name = "Clinician" + pId;

          this.socket.emit("GETDATA", { type: type, name: name });
          this.session_start = moment();

          firebase.database().ref("sesssions").push(
            {
              event: "StartSession",
              timeStamp: "" + moment(),
              patientId: pId,
              userId: firebase.auth().currentUser.email
            }
          );
          
          client.connect(1234, "127.0.0.1", function(err)
          {
            console.log("Get kinect Data: " + err);
            
          });
          client.on("data", function(data)
          {
            console.log(data);
            app.kinectData = data;
          });
          client.on("close", function()
          {
              console.log("connection closed");
          });

      },
    backToStart() {
      if (this.game != null) {
        this.game.kill();
      }

      this.currentView = "start"
    },
    endSession() {
      console.log("disocnnect");

      this.socket.emit("removeClient", { name: "Clinician" + this.patient_id, type: "Clinician" });
      //this.socket.emit("disconnect");
      this.patient_id = "";
      this.session_start = null;
      this.currentView = "login";
    },
    duration() {
      let n = this.now;
      let s = this.session_start;
      let d = moment.duration(n.diff(s));
      let r = d.humanize();
      return r;
    },
    logout() {
      this.endSession();
      this.socket.disconnect();
      window.location = "../index.html";
    },
    user() {
      if (firebase.auth().currentUser)
        return firebase.auth().currentUser.email;
      else
        return "Waiting for credentials to arrive.";
    },
    setText(txt)
    {
      setTimeout(function () {
        var ct = document.getElementById("ttt");

        console.log(ct == null);
        ct.innerHTML = txt;
      }, 200);

    }
      }

    });

    setInterval(() => app.now = moment(), 1000);



  </script>
</body>

</html>